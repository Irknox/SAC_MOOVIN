services:
  app:
    build: .
    env_file:
      - .env
    environment:
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379/0
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: ["redis-server","--appendonly","yes","--save","60","1","--requirepass","${REDIS_PASSWORD}"]
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD","sh","-lc","redis-cli -a \"$REDIS_PASSWORD\" ping | grep PONG"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  realtime-agent:
    build: .
    container_name: realtime-agent
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - RTP_BIND_HOST=0.0.0.0
      - RTP_BIND_PORT=40000
      - RTP_PAYLOAD=alaw
      - RTP_PTIME_MS=20
    ports:
      - "7000:7000/tcp"      
      - "40000:40000/udp" 
    volumes:
      - /moovin_agents_SDK
    working_dir: /app
    command: ["python", "SilverAI_Voice.py"]

  silverai-ari:
    build: .
    container_name: silverai-ari
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - ARI_URL=${ARI_URL}                
      - ARI_USER=${ARI_USER}               
      - ARI_PASS=${ARI_PASS}
      - ARI_APP=${ARI_APP}                 
      - EXTERNAL_HOST=${EXTERNAL_HOST}     
      - EXTERNAL_FORMAT=${EXTERNAL_FORMAT} 
      - EXTERNAL_TRANSPORT=${EXTERNAL_TRANSPORT}       
      - EXTERNAL_ENCAPSULATION=${EXTERNAL_ENCAPSULATION}
      - EXTERNAL_DIRECTION=${EXTERNAL_DIRECTION}      
      - LOG_LEVEL=${LOG_LEVEL}
      - MAX_CALL_MS=${MAX_CALL_MS}
    network_mode: host
    depends_on:
      - realtime-agent      
    volumes:
      - /moovin_agents_SDK
    working_dir: /app
    command: ["python", "SilverAI_ari.py"]
    
  ui_api:
    build: .
    env_file:
      - .env
    environment:
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379/0
    command: uvicorn api_manager_ui:app --host 0.0.0.0 --port 7575
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./moovin_agents_SDK/prompts:/app/prompts:rw
    restart: unless-stopped

  # Frontend
  web:
    build:
      context: ./sac_manager_ui
      args:
        NEXT_PUBLIC_BASE_PATH: /SilverAI/ManagerUI
        NEXT_PUBLIC_MANAGER_API_BASE: /SilverAI/Manager
    env_file:
      - ./sac_manager_ui/.env
    environment:
      - COOKIE_SECURE=false   # en local HTTP
    # - COOKIE_SECURE=true  # en prod con HTTPS en el gateway

  gateway:
    image: nginx:alpine
    depends_on:
      - web
      - app
      - ui_api
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped

volumes:
  redis-data:
