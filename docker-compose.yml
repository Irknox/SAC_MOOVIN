services:
  app:
    build: .
    env_file:
      - .env
    environment:
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379/0
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped


  redis:
    image: redis:7-alpine
    command: ["redis-server","--appendonly","yes","--save","60","1","--requirepass","${REDIS_PASSWORD}"]
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD","sh","-lc","redis-cli -a \"$REDIS_PASSWORD\" ping | grep PONG"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # Backend del Front (api_manager_ui.py)
  ui_api:
    build: .
    command: uvicorn api_manager_ui:app --host 0.0.0.0 --port 7575
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./moovin_agents_SDK/prompts:/app/prompts:rw
    restart: unless-stopped

  # Frontend
  web:
    build:
      context: ./sac_manager_ui
      args:
        NEXT_PUBLIC_BASE_PATH: /SilverAI/ManagerUI
        NEXT_PUBLIC_MANAGER_API_BASE: /SilverAI/Manager
    env_file:
      - ./sac_manager_ui/.env
    environment:
    - COOKIE_SECURE=false   # en local HTTP
    # - COOKIE_SECURE=true  # en prod con HTTPS en el gateway

  gateway:
    image: nginx:alpine
    depends_on:
      - web
      - app
      - ui_api
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped

volumes:
  redis-data:
