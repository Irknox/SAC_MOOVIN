services:
  app:
    build: .
    env_file:
      - .env
    environment:
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379/0
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command:
      [
        "redis-server",
        "--appendonly","yes",
        "--save","60","1",
        "--requirepass","${REDIS_PASSWORD}",
        "--bind","0.0.0.0",
        "--protected-mode","no"
      ]
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD","sh","-lc","redis-cli -a \"$REDIS_PASSWORD\" ping | grep PONG"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  ui_api:
      build: .
      env_file:
        - .env
      environment:
        REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379/0
      command: uvicorn api_manager_ui:app --host 0.0.0.0 --port 7575
      depends_on:
        redis:
          condition: service_healthy
      volumes:
        - ./moovin_agents_SDK/prompts:/app/prompts:rw
      restart: unless-stopped

  silverai_voice:
    build:
      context: .
      args:
        REQS_FILE: requirements_voice.txt
    container_name: silverai_voice
    working_dir: /app
    volumes:
      - ./moovin_agents_SDK:/app
    command: ["python","-u", "SilverAI_Voice/SilverAI.py"]
    env_file:
      - .env
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_WEBHOOK_SECRET=${OPENAI_WEBHOOK_KEY}
      - PYTHONUNBUFFERED=1
    expose:
      - "8585"
    networks:
      - default
      - telephony
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  silverai-ari:
    image: node:20
    container_name: silverai-ari
    working_dir: /app
    env_file:
      - .env
    volumes:
      - ./moovin_agents_SDK:/app
    environment:
      REDIS_URL: "redis://:${REDIS_PASSWORD}@127.0.0.1:6379/0"
      ARI_URL: "${ARI_URL}"
      ARI_USER: "${ARI_USER:-asterisk}"
      ARI_PASS: "${ARI_PASS:-asterisk}"
      ARI_APP:  "${ARI_APP:-SilverAI}"
      LOG_LEVEL: "${LOG_LEVEL:-INFO}"
    depends_on:
      redis:
        condition: service_healthy

    command: >
      bash -lc "
        command -v npm || (apt-get update && apt-get install -y npm) &&
        node -v && npm -v &&
        npm init -y >/dev/null 2>&1 || true &&
        npm i ari-client dotenv express redis &&
        node SilverAI_Voice/SilverAI_ari.js
      "
    network_mode: "host"

  web:
    build:
      context: ./sac_manager_ui
      args:
        NEXT_PUBLIC_BASE_PATH: /SilverAI/ManagerUI
        NEXT_PUBLIC_MANAGER_API_BASE: /SilverAI/Manager
    env_file:
      - ./sac_manager_ui/.env
    environment:
      - COOKIE_SECURE=false   # en local HTTP
     # - COOKIE_SECURE=true  # en prod con HTTPS en el gateway

  gateway:
    image: nginx:alpine
    depends_on:
      - app
      - ui_api
    ports:
      # - "80:80"
      - "443:443"   
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro  
    networks:
      - default  
      - telephony 
    restart: unless-stopped

networks:
  telephony: {}

volumes:
  redis-data:
