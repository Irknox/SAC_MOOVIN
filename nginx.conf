# Upstreams internos (por nombre de servicio de Docker)
upstream app_backend   { server app:8989; }     # Backend SDK (api.py)
upstream ui_backend    { server ui_api:7575; }  # Backend del front (api_manager_ui.py)
upstream frontend_web  { server web:80; }       # Frontend estático servido por Nginx del contenedor "web"

server {
  listen 80;
  server_name _;

  # Normaliza /SilverAI sin barra final -> redirige a /SilverAI/
  location = /SilverAI {
    return 301 /SilverAI/;
  }

  # ---- Frontend (SPA) bajo /SilverAI/ManagerUI/ ----
  # Envía /SilverAI/ManagerUI/... al contenedor "web" (Nginx estático)
  location /SilverAI/ManagerUI/ {
    proxy_pass http://frontend_web/;  # BARRA FINAL: elimina /SilverAI/ManagerUI/ del path
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;

    # (Opcional) SPA fallback aquí si el "web" no lo maneja por sí mismo
    # para que /SilverAI/ManagerUI/ruta/cliente sirva index.html
    proxy_intercept_errors on;
    error_page 404 = @managerui_index;
  }

  location @managerui_index {
    internal;
    proxy_pass http://frontend_web/index.html;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
  }

  # ---- Backend del Front bajo /SilverAI/Manager/ ----
  # Envía /SilverAI/Manager/... al contenedor ui_api:7575
  location /SilverAI/Manager/ {
    proxy_pass http://ui_backend/;  # BARRA FINAL: elimina /SilverAI/Manager/ del path
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
  }

  # ---- Backend SDK bajo /SilverAI/... ----
  # 1) Endpoint exacto para /SilverAI/ask (caso típico)
  location = /SilverAI/ask {
    proxy_pass http://app_backend/ask;  # sin barra final: conserva /ask
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
  }

  # 2) Cualquier otra ruta /SilverAI/<lo-que-sea> va al Backend SDK
  # (queda al final para no tapar ManagerUI/ ni Manager/)
  location /SilverAI/ {
    proxy_pass http://app_backend/;  # BARRA FINAL: elimina /SilverAI/ del path
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
  }
}
